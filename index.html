<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Looper</title>
  <style>
    /* Reset and base styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Main container */
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 720px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* Header */
    h1 {
      font-size: 32px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #718096;
      font-size: 14px;
      margin-bottom: 32px;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Time inputs row */
    .time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Button */
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 32px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    /* Player container */
    #player {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      display: none;
    }

    #player.active {
      display: block;
    }

    /* Status message */
    .status {
      margin-top: 16px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 13px;
      color: #4a5568;
      text-align: center;
      display: none;
    }

    .status.active {
      display: block;
    }

    /* Helper text */
    .helper-text {
      font-size: 12px;
      color: #a0aec0;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouTube Looper</h1>
    <p class="subtitle">Loop any section of a YouTube video</p>

    <!-- Input form -->
    <div class="form-group">
      <label for="videoUrl">YouTube URL</label>
      <input 
        type="text" 
        id="videoUrl" 
        placeholder="https://www.youtube.com/watch?v=..." 
        value="https://www.youtube.com/watch?v=w-Ep1j1K_qk"
      >
      <div class="helper-text">Paste any YouTube video URL</div>
    </div>

    <div class="time-inputs">
      <div class="form-group">
        <label for="startTime">Start Time (seconds)</label>
        <input 
          type="number" 
          id="startTime" 
          placeholder="0" 
          value="50.95"
          step="0.01"
          min="0"
        >
      </div>

      <div class="form-group">
        <label for="endTime">End Time (seconds)</label>
        <input 
          type="number" 
          id="endTime" 
          placeholder="60" 
          value="54.5"
          step="0.01"
          min="0"
        >
      </div>
    </div>

    <button onclick="loadVideo()">Load & Loop</button>

    <!-- YouTube player container -->
    <div id="player"></div>

    <!-- Status message -->
    <div id="status" class="status"></div>
  </div>

  <script>
    // Global variables
    let player;
    let loopSection = { start: 0, end: 0 };
    let isLooping = false;
    let apiReady = false;
    let pendingVideoId = null;
    let loopTimeout = null;

    // Load YouTube IFrame API asynchronously
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    /**
     * Extract video ID from various YouTube URL formats
     * Supports: youtube.com/watch?v=ID, youtu.be/ID, youtube.com/embed/ID
     */
    function extractVideoId(url) {
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/  // Direct video ID
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }

    /**
     * Load video with user-specified parameters
     * Called when user clicks "Load & Loop" button
     */
    function loadVideo() {
      const url = document.getElementById('videoUrl').value;
      const startTime = parseFloat(document.getElementById('startTime').value) || 0;
      const endTime = parseFloat(document.getElementById('endTime').value) || 0;

      // Validate inputs
      if (!url) {
        showStatus('Please enter a YouTube URL');
        return;
      }

      const videoId = extractVideoId(url);
      if (!videoId) {
        showStatus('Invalid YouTube URL. Please check and try again.');
        return;
      }

      if (endTime <= startTime) {
        showStatus('End time must be greater than start time');
        return;
      }

      // Update loop section
      loopSection = { start: startTime, end: endTime };

      // Check if YouTube API is ready
      if (!apiReady) {
        // Queue the video to load once API is ready
        pendingVideoId = videoId;
        showStatus('Loading YouTube API...');
        return;
      }

      // Initialize or load new video
      if (player) {
        player.loadVideoById(videoId);
        showStatus(`Loading video... Loop: ${startTime}s - ${endTime}s`);
      } else {
        // Create player for the first time
        initializePlayer(videoId);
      }

      // Show player
      document.getElementById('player').classList.add('active');
    }

    /**
     * Initialize YouTube player
     * This is called by the YouTube API when it's ready
     */
    function initializePlayer(videoId) {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: videoId,
        playerVars: {
          'playsinline': 1,
          'rel': 0
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    /**
     * Called when player is ready
     * Seeks to start time and begins playback
     */
    function onPlayerReady(event) {
      player.seekTo(loopSection.start, true);
      player.playVideo();
      isLooping = true;
      showStatus(`Looping: ${loopSection.start}s - ${loopSection.end}s`);
    }

    /**
     * Monitor player state changes
     * Sets up the loop timer when video starts playing
     */
    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && isLooping) {
        const currentTime = player.getCurrentTime();
        
        // If we're outside the loop range, jump to start
        if (currentTime < loopSection.start || currentTime >= loopSection.end) {
          player.seekTo(loopSection.start, true);
        }
        
        // Clear any existing timeout to avoid overlapping timers
        if (loopTimeout) {
          clearTimeout(loopTimeout);
        }
        
        // Calculate time until loop end
        const timeUntilEnd = loopSection.end - Math.max(currentTime, loopSection.start);
        
        // Schedule restart at the end of the section
        loopTimeout = setTimeout(restartLoop, timeUntilEnd * 1000);
      }
    }

    /**
     * Restart the loop by seeking back to start time
     */
    function restartLoop() {
      if (player && isLooping && player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.seekTo(loopSection.start, true);
      }
    }

    /**
     * Display status message to user
     */
    function showStatus(message) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.classList.add('active');
    }

    /**
     * Callback for YouTube IFrame API
     * Called automatically when API is ready
     */
    window.onYouTubeIframeAPIReady = function() {
      console.log('YouTube API ready');
      apiReady = true;
      
      // Process any pending video load request
      if (pendingVideoId) {
        const videoId = pendingVideoId;
        pendingVideoId = null;
        initializePlayer(videoId);
        document.getElementById('player').classList.add('active');
      }
    };
  </script>
</body>
</html>
